var UltimateLoader=UltimateLoader||{};!function(e){"use strict";function t(e,t,r){E.push([e,t,r])}function r(){if(v>E.length-1)return E=[],void(v=0);var e=E[v];v++,i(e[0],e[1],e[2])}function a(){0==v&&r()}function i(e,t,a){var i=s(n(e));switch(i.url=e,i.callback=t,null!=a&&(i.i=a),i.ext){case"obj":o(i);break;case"json":h(i);break;case"dae":c(i);break;case"gltf":d(i);break;case"glb":d(i);break;case"fbx":loadFBX(i);break;case"drc":loadDRACO(i);break;case"png":u(i);break;case"jpg":u(i);break;case"jpeg":u(i);break;case"bom":l(i);break;default:console.log("UltimateLoader: File extension -"+i.ext+"- not recognized! Object -"+i.name+"- did not load."),r()}}function s(e){var t=e.slice(0,e.lastIndexOf("/")+1),r=e.substr(e.lastIndexOf("/")+1),a=r.split("."),i=a[0],s=a[a.length-1].toLowerCase(),n={name:i,ext:s,baseUrl:t};return n}function n(e,t){if("string"!=typeof e||""===e)return"";if(/^(https?:)?\/\//i.test(e))return e;if(/^data:.*,.*$/i.test(e))return e;var r=new URL((t||"")+e,location.href.substring(0,location.href.lastIndexOf("/")+1));return r.toString()}function o(e){var t=e.name+".obj",r=e.name+".mtl",a=new THREE.MTLLoader;a.setPath(e.baseUrl),a.setTexturePath?a.setTexturePath(e.baseUrl):a.setBaseUrl(e.baseUrl),a.setCrossOrigin(g),a.load(r,function(r){r.preload();var a=new THREE.OBJLoader;a.setMaterials(r),a.setPath(e.baseUrl),a.load(t,function(t){e.object=t,m(e)},p,f)})}function l(e){var t=e.name+".bom",r=new THREE.BOMLoader;r.setPath(e.baseUrl),r.setTexturePath(e.baseUrl),r.setCrossOrigin(g),r.load(t,function(t){e.object=t,m(e)},p,f)}function h(e){var t=new THREE.ObjectLoader;t.load(e.url,function(t){e.object=t,m(e)},p,f)}function c(e){var t=new THREE.ColladaLoader;t.load(e.url,function(t){var r=t.scene;e.object=r,m(e)},p,f)}function u(t){var r=new THREE.TextureLoader;r.load(t.url,function(r){var a=r;if(e.loadImagesOnPlane){var i=r.image.naturalHeight/r.image.naturalWidth*e.imageSize,s=new THREE.PlaneGeometry(e.imageSize,i,e.imageSize),n=new THREE.MeshBasicMaterial({map:r,side:THREE.DoubleSide}),o=new THREE.Mesh(s,n);a=o}t.object=a,m(t)},p,f)}function d(e){var t=new THREE.GLTFLoader;t.load(e.url,function(t){var r=t.scene;e.object=r,m(e)},p,f)}function p(e){}function f(e){console.log("There was an error loading your object")}function m(t){null!=t.i?t.callback(t):t.callback(t.object),e.useQueue&&r(),console.log("UltimateLoader: Object "+t.name+" loaded!")}var E=[],v=0,g="anonymous";e.useQueue=!1,e.imageSize=32,e.loadImagesOnPlane=!1,e.load=function(r,s){e.useQueue?(t(r,s),a()):i(r,s)},e.multiload=function(r,s){console.time("Time");for(var n=[],o=0,l=function(e){n[e.i]=e.object,o++,o==r.length&&(s(n),console.timeEnd("Time"))},h=0;h<r.length;h++)e.useQueue?(t(r[h],l,h),a()):i(r[h],l,h)}}(UltimateLoader),THREE.FileLoader=THREE.FileLoader||THREE.XHRLoader,THREE.MTLLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.MTLLoader.prototype={constructor:THREE.MTLLoader,load:function(e,t,r,a){var i=this,s=new THREE.FileLoader(this.manager);s.setPath(this.path),s.load(e,function(e){t(i.parse(e))},r,a)},setPath:function(e){this.path=e},setTexturePath:function(e){this.texturePath=e},setBaseUrl:function(e){console.warn("THREE.MTLLoader: .setBaseUrl() is deprecated. Use .setTexturePath( path ) for texture path or .setPath( path ) for general base path instead."),this.setTexturePath(e)},setCrossOrigin:function(e){this.crossOrigin=e},setMaterialOptions:function(e){this.materialOptions=e},parse:function(e){for(var t=e.split("\n"),r={},a=/\s+/,i={},s=0;s<t.length;s++){var n=t[s];if(n=n.trim(),0!==n.length&&"#"!==n.charAt(0)){var o=n.indexOf(" "),l=o>=0?n.substring(0,o):n;l=l.toLowerCase();var h=o>=0?n.substring(o+1):"";if(h=h.trim(),"newmtl"===l)r={name:h},i[h]=r;else if(r)if("ka"===l||"kd"===l||"ks"===l){var c=h.split(a,3);r[l]=[parseFloat(c[0]),parseFloat(c[1]),parseFloat(c[2])]}else r[l]=h}}var u=new THREE.MTLLoader.MaterialCreator(this.texturePath||this.path,this.materialOptions);return u.setCrossOrigin(this.crossOrigin),u.setManager(this.manager),u.setMaterials(i),u}},THREE.MTLLoader.MaterialCreator=function(e,t){this.baseUrl=e||"",this.options=t,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:THREE.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:THREE.RepeatWrapping},THREE.MTLLoader.MaterialCreator.prototype={constructor:THREE.MTLLoader.MaterialCreator,setCrossOrigin:function(e){this.crossOrigin=e},setManager:function(e){this.manager=e},setMaterials:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(e){if(!this.options)return e;var t={};for(var r in e){var a=e[r],i={};t[r]=i;for(var s in a){var n=!0,o=a[s],l=s.toLowerCase();switch(l){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(o=[o[0]/255,o[1]/255,o[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===o[0]&&0===o[1]&&0===o[2]&&(n=!1)}n&&(i[l]=o)}}return t},preload:function(){for(var e in this.materialsInfo)this.create(e)},getIndex:function(e){return this.nameLookup[e]},getAsArray:function(){var e=0;for(var t in this.materialsInfo)this.materialsArray[e]=this.create(t),this.nameLookup[t]=e,e++;return this.materialsArray},create:function(e){return void 0===this.materials[e]&&this.createMaterial_(e),this.materials[e]},createMaterial_:function(e){function t(e,t){return"string"!=typeof t||""===t?"":/^https?:\/\//i.test(t)?t:e+t}function r(e,r){if(!s[e]){var i=a.getTextureParams(r,s),n=a.loadTexture(t(a.baseUrl,i.url));n.repeat.copy(i.scale),n.offset.copy(i.offset),n.wrapS=a.wrap,n.wrapT=a.wrap,s[e]=n}}var a=this,i=this.materialsInfo[e],s={name:e,side:this.side};for(var n in i){var o=i[n];if(""!==o)switch(n.toLowerCase()){case"kd":s.color=(new THREE.Color).fromArray(o);break;case"ks":s.specular=(new THREE.Color).fromArray(o);break;case"map_kd":r("map",o);break;case"map_ks":r("specularMap",o);break;case"map_bump":case"bump":r("bumpMap",o);break;case"ns":s.shininess=parseFloat(o);break;case"d":o<1&&(s.opacity=o,s.transparent=!0);break;case"Tr":o>0&&(s.opacity=1-o,s.transparent=!0)}}return this.materials[e]=new THREE.MeshPhongMaterial(s),this.materials[e]},getTextureParams:function(e,t){var r,a={scale:new THREE.Vector2(1,1),offset:new THREE.Vector2(0,0)},i=e.split(/\s+/);return r=i.indexOf("-bm"),r>=0&&(t.bumpScale=parseFloat(i[r+1]),i.splice(r,2)),r=i.indexOf("-s"),r>=0&&(a.scale.set(parseFloat(i[r+1]),parseFloat(i[r+2])),i.splice(r,4)),r=i.indexOf("-o"),r>=0&&(a.offset.set(parseFloat(i[r+1]),parseFloat(i[r+2])),i.splice(r,4)),a.url=i.join(" ").trim(),a},loadTexture:function(e,t,r,a,i){var s;if(altspace&&altspace.inClient)s=new THREE.Texture({src:e});else{var n=THREE.Loader.Handlers.get(e),o=void 0!==this.manager?this.manager:THREE.DefaultLoadingManager;null===n&&(n=new THREE.TextureLoader(o)),n.setCrossOrigin&&n.setCrossOrigin(this.crossOrigin),s=n.load(e,r,a,i)}return void 0!==t&&(s.mapping=t),s}},THREE.OBJLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.materials=null,this.regexp={vertex_pattern:/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,normal_pattern:/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,uv_pattern:/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /}},THREE.OBJLoader.prototype={constructor:THREE.OBJLoader,load:function(e,t,r,a){var i=this,s=new THREE.FileLoader(i.manager);s.setPath(this.path),s.load(e,function(e){t(i.parse(e))},r,a)},setPath:function(e){this.path=e},setMaterials:function(e){this.materials=e},_createParserState:function(){var e={objects:[],object:{},vertices:[],normals:[],uvs:[],materialLibraries:[],startObject:function(e,t){if(this.object&&this.object.fromDeclaration===!1)return this.object.name=e,void(this.object.fromDeclaration=t!==!1);var r=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:t!==!1,geometry:{vertices:[],normals:[],uvs:[]},materials:[],smooth:!0,startMaterial:function(e,t){var r=this._finalize(!1);r&&(r.inherited||r.groupCount<=0)&&this.materials.splice(r.index,1);var a={index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&t.length>0?t[t.length-1]:"",smooth:void 0!==r?r.smooth:this.smooth,groupStart:void 0!==r?r.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){var t={index:"number"==typeof e?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return t.clone=this.clone.bind(t),t}};return this.materials.push(a),a},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(e){var t=this.currentMaterial();if(t&&t.groupEnd===-1&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),e&&this.materials.length>1)for(var r=this.materials.length-1;r>=0;r--)this.materials[r].groupCount<=0&&this.materials.splice(r,1);return e&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),t}},r&&r.name&&"function"==typeof r.clone){var a=r.clone(0);a.inherited=!0,this.object.materials.push(a)}this.objects.push(this.object)},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0)},parseVertexIndex:function(e,t){var r=parseInt(e,10);return 3*(r>=0?r-1:r+t/3)},parseNormalIndex:function(e,t){var r=parseInt(e,10);return 3*(r>=0?r-1:r+t/3)},parseUVIndex:function(e,t){var r=parseInt(e,10);return 2*(r>=0?r-1:r+t/2)},addVertex:function(e,t,r){var a=this.vertices,i=this.object.geometry.vertices;i.push(a[e+0]),i.push(a[e+1]),i.push(a[e+2]),i.push(a[t+0]),i.push(a[t+1]),i.push(a[t+2]),i.push(a[r+0]),i.push(a[r+1]),i.push(a[r+2])},addVertexLine:function(e){var t=this.vertices,r=this.object.geometry.vertices;r.push(t[e+0]),r.push(t[e+1]),r.push(t[e+2])},addNormal:function(e,t,r){var a=this.normals,i=this.object.geometry.normals;i.push(a[e+0]),i.push(a[e+1]),i.push(a[e+2]),i.push(a[t+0]),i.push(a[t+1]),i.push(a[t+2]),i.push(a[r+0]),i.push(a[r+1]),i.push(a[r+2])},addUV:function(e,t,r){var a=this.uvs,i=this.object.geometry.uvs;i.push(a[e+0]),i.push(a[e+1]),i.push(a[t+0]),i.push(a[t+1]),i.push(a[r+0]),i.push(a[r+1])},addUVLine:function(e){var t=this.uvs,r=this.object.geometry.uvs;r.push(t[e+0]),r.push(t[e+1])},addFace:function(e,t,r,a,i,s,n,o,l,h,c,u){var d,p=this.vertices.length,f=this.parseVertexIndex(e,p),m=this.parseVertexIndex(t,p),E=this.parseVertexIndex(r,p);if(void 0===a?this.addVertex(f,m,E):(d=this.parseVertexIndex(a,p),this.addVertex(f,m,d),this.addVertex(m,E,d)),void 0!==i){var v=this.uvs.length;f=this.parseUVIndex(i,v),m=this.parseUVIndex(s,v),E=this.parseUVIndex(n,v),void 0===a?this.addUV(f,m,E):(d=this.parseUVIndex(o,v),this.addUV(f,m,d),this.addUV(m,E,d))}if(void 0!==l){var g=this.normals.length;f=this.parseNormalIndex(l,g),m=l===h?f:this.parseNormalIndex(h,g),E=l===c?f:this.parseNormalIndex(c,g),void 0===a?this.addNormal(f,m,E):(d=this.parseNormalIndex(u,g),this.addNormal(f,m,d),this.addNormal(m,E,d))}},addLineGeometry:function(e,t){this.object.geometry.type="Line";for(var r=this.vertices.length,a=this.uvs.length,i=0,s=e.length;i<s;i++)this.addVertexLine(this.parseVertexIndex(e[i],r));for(var n=0,s=t.length;n<s;n++)this.addUVLine(this.parseUVIndex(t[n],a))}};return e.startObject("",!1),e},parse:function(e){console.time("OBJLoader");var t=this._createParserState();e.indexOf("\r\n")!==-1&&(e=e.replace(/\r\n/g,"\n")),e.indexOf("\\\n")!==-1&&(e=e.replace(/\\\n/g,""));for(var r=e.split("\n"),a="",i="",s="",n=0,o=[],l="function"==typeof"".trimLeft,h=0,c=r.length;h<c;h++)if(a=r[h],a=l?a.trimLeft():a.trim(),n=a.length,0!==n&&(i=a.charAt(0),"#"!==i))if("v"===i)if(s=a.charAt(1)," "===s&&null!==(o=this.regexp.vertex_pattern.exec(a)))t.vertices.push(parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3]));else if("n"===s&&null!==(o=this.regexp.normal_pattern.exec(a)))t.normals.push(parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3]));else{if("t"!==s||null===(o=this.regexp.uv_pattern.exec(a)))throw new Error("Unexpected vertex/normal/uv line: '"+a+"'");t.uvs.push(parseFloat(o[1]),parseFloat(o[2]))}else if("f"===i)if(null!==(o=this.regexp.face_vertex_uv_normal.exec(a)))t.addFace(o[1],o[4],o[7],o[10],o[2],o[5],o[8],o[11],o[3],o[6],o[9],o[12]);else if(null!==(o=this.regexp.face_vertex_uv.exec(a)))t.addFace(o[1],o[3],o[5],o[7],o[2],o[4],o[6],o[8]);else if(null!==(o=this.regexp.face_vertex_normal.exec(a)))t.addFace(o[1],o[3],o[5],o[7],void 0,void 0,void 0,void 0,o[2],o[4],o[6],o[8]);else{if(null===(o=this.regexp.face_vertex.exec(a)))throw new Error("Unexpected face line: '"+a+"'");t.addFace(o[1],o[2],o[3],o[4])}else if("l"===i){var u=a.substring(1).trim().split(" "),d=[],p=[];if(a.indexOf("/")===-1)d=u;else for(var f=0,m=u.length;f<m;f++){var E=u[f].split("/");""!==E[0]&&d.push(E[0]),""!==E[1]&&p.push(E[1])}t.addLineGeometry(d,p)}else if(null!==(o=this.regexp.object_pattern.exec(a))){var v=(" "+o[0].substr(1).trim()).substr(1);t.startObject(v)}else if(this.regexp.material_use_pattern.test(a))t.object.startMaterial(a.substring(7).trim(),t.materialLibraries);else if(this.regexp.material_library_pattern.test(a))t.materialLibraries.push(a.substring(7).trim());else{if(null===(o=this.regexp.smoothing_pattern.exec(a))){if("\0"===a)continue;throw new Error("Unexpected line: '"+a+"'")}var g=o[1].trim().toLowerCase();t.object.smooth="1"===g||"on"===g;var T=t.object.currentMaterial();T&&(T.smooth=t.object.smooth)}t.finalize();var b=new THREE.Group;b.materialLibraries=[].concat(t.materialLibraries);for(var h=0,c=t.objects.length;h<c;h++){var y=t.objects[h],R=y.geometry,w=y.materials,x="Line"===R.type;if(0!==R.vertices.length){var A=new THREE.BufferGeometry;A.addAttribute("position",new THREE.BufferAttribute(new Float32Array(R.vertices),3)),R.normals.length>0?A.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(R.normals),3)):A.computeVertexNormals(),R.uvs.length>0&&A.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(R.uvs),2));for(var N=[],M=0,H=w.length;M<H;M++){var L=w[M],T=void 0;if(null!==this.materials&&(T=this.materials.create(L.name),x&&T&&!(T instanceof THREE.LineBasicMaterial))){var _=new THREE.LineBasicMaterial;_.copy(T),T=_}T||(T=x?new THREE.LineBasicMaterial:new THREE.MeshPhongMaterial,T.name=L.name),T.shading=L.smooth?THREE.SmoothShading:THREE.FlatShading,N.push(T)}var S;if(N.length>1){for(var M=0,H=w.length;M<H;M++){var L=w[M];A.addGroup(L.groupStart,L.groupCount,M)}var k=new THREE.MultiMaterial(N);S=x?new THREE.LineSegments(A,k):new THREE.Mesh(A,k)}else S=x?new THREE.LineSegments(A,N[0]):new THREE.Mesh(A,N[0]);S.name=y.name,b.add(S)}}return console.log("------------ UltimateLoader ---------------"),console.timeEnd("OBJLoader"),b}},THREE.ColladaLoader=function(){function e(e,r,a,i){var s=0;if(document.implementation&&document.implementation.createDocument){var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState?0===n.status||200===n.status?n.response?(Ue=r,t(n.response,void 0,e)):i?i({type:"error",url:e}):console.error("ColladaLoader: Empty or non-existing file ("+e+")"):i?i({type:"error",url:e}):console.error("ColladaLoader: Couldn't load \""+e+'" ('+n.status+")"):3===n.readyState&&a&&(0===s&&(s=n.getResponseHeader("Content-Length")),a({total:s,loaded:n.responseText.length}))},n.open("GET",e,!0),n.send(null)}else alert("Don't know how to parse XML!")}function t(e,t,r){if(console.time("ColladaLoader"),je=(new DOMParser).parseFromString(e,"text/xml"),t=t||Ue,void 0!==r){var l=r.split("/");l.pop(),Ce=(l.length<1?".":l.join("/"))+"/"}a(),ye(),De=i("library_images image",N,"image"),qe=i("library_materials material",X,"material"),Xe=i("library_effects effect",J,"effect"),Ye=i("library_geometries geometry",F,"geometry"),ze=i("library_cameras camera",ae,"camera"),We=i("library_lights light",se,"light"),Ge=i("library_controllers controller",M,"controller"),Ve=i("library_animations animation",$,"animation"),ke=i("library_visual_scenes visual_scene",_,"visual_scene"),Oe=i("library_kinematics_models kinematics_model",oe,"kinematics_model"),Ie=[],Fe=[],He=s(),Pe=new THREE.Group;for(var h=0;h<He.nodes.length;h++)Pe.add(v(He.nodes[h]));Pe.scale.multiplyScalar(Je),o(),Le=n(),E();var c={scene:Pe,morphs:Ie,skins:Fe,animations:_e,kinematics:Se,dae:{images:De,materials:qe,cameras:ze,lights:We,effects:Xe,geometries:Ye,controllers:Ge,animations:Ve,visualScenes:ke,visualScene:He,scene:He,kinematicsModels:Oe,kinematicsModel:Le}};return console.log("------------ UltimateLoader ---------------"),console.timeEnd("ColladaLoader"),t&&t(c),c}function r(e){Ze=e}function a(){var e=je.querySelectorAll("asset"),t=e[0];if(t&&t.childNodes)for(var r=0;r<t.childNodes.length;r++){var a=t.childNodes[r];switch(a.nodeName){case"unit":var i=a.getAttribute("meter");i&&(Je=parseFloat(i));break;case"up_axis":Qe=a.textContent.charAt(0)}}}function i(e,t,r){for(var a=je.querySelectorAll(e),i={},s=0,n=a.length,o=0;o<n;o++){var l=a[o],h=(new t).parse(l);h.id&&0!==h.id.length||(h.id=r+s++),i[h.id]=h}return i}function s(){var e=je.querySelectorAll("scene instance_visual_scene")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return ke[t.length>0?t:"visual_scene0"]}return null}function n(){var e=je.querySelectorAll("instance_kinematics_model")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Oe[t.length>0?t:"kinematics_model0"]}return null}function o(){_e=[],l(Pe)}function l(e){var t=He.getChildById(e.colladaId,!0),r=null;if(t&&t.keys){r={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0},_e.push(r);for(var a=0,i=t.keys.length;a<i;a++)r.length=Math.max(r.length,t.keys[a].time)}else r={hierarchy:[{keys:[],sids:[]}]};for(var a=0,i=e.children.length;a<i;a++)for(var s=l(e.children[a]),n=0,o=s.hierarchy.length;n<o;n++)r.hierarchy.push({keys:[],sids:[]});return r}function h(){var e,t=1e6,r=-t,a=0;for(var i in Ve){var s=Ve[i];e=e||s.id;for(var n=0;n<s.sampler.length;n++){var o=s.sampler[n];o.create(),t=Math.min(t,o.startTime),r=Math.max(r,o.endTime),a=Math.max(a,o.input.length)}}return{start:t,end:r,frames:a,ID:e}}function c(e,t){var r=t instanceof O?Ge[t.url]:t;if(!r||!r.morph)return void console.log("could not find morph controller!");for(var a=r.morph,i=0;i<a.targets.length;i++){var s=a.targets[i],n=Ye[s];if(n.mesh&&n.mesh.primitives&&n.mesh.primitives.length){var o=n.mesh.primitives[0].geometry;o.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:o.vertices})}}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}function u(e,t,r,a){if(e.world=e.world||new THREE.Matrix4,e.localworld=e.localworld||new THREE.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){var i=e.channels[0],s=i.sampler.output[r];s instanceof THREE.Matrix4&&(e.world.copy(s),e.localworld.copy(s),0===r&&e.matrix.copy(s))}a&&e.world.multiplyMatrices(a,e.world),t.push(e);for(var n=0;n<e.nodes.length;n++)u(e.nodes[n],t,r,e.world)}function d(e,t){for(var r=0;r<e.length;r++){var a=e[r],i=-1;if("JOINT"==a.type){for(var s=0;s<t.joints.length;s++)if(a.sid===t.joints[s]){i=s;break}if(i>=0){var n=t.invBindMatrices[i];a.invBindMatrix=n,a.skinningMatrix=new THREE.Matrix4,a.skinningMatrix.multiplyMatrices(a.world,n),a.animatrix=new THREE.Matrix4,a.animatrix.copy(a.localworld),a.weights=[];for(var s=0;s<t.weights.length;s++)for(var o=0;o<t.weights[s].length;o++){var l=t.weights[s][o];l.joint===i&&a.weights.push(l)}}else console.warn("ColladaLoader: Could not find joint '"+a.sid+"'."),a.skinningMatrix=new THREE.Matrix4,a.weights=[]}}}function p(e){var t=[],r=function(e,t,a){var i={};i.name=t.sid,i.parent=e,i.matrix=t.matrix;var s=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];i.matrix.decompose(s[0],s[1],s[2]),i.pos=[s[0].x,s[0].y,s[0].z],i.scl=[s[2].x,s[2].y,s[2].z],i.rotq=[s[1].x,s[1].y,s[1].z,s[1].w],a.push(i);for(var n in t.nodes)r(t.sid,t.nodes[n],a)};return r(-1,e,t),t}function f(e,t,r){var a=[];u(t,a,-1),d(a,r.skin);for(var i=new THREE.Vector3,s=[],n=0;n<e.vertices.length;n++)s.push(new THREE.Vector3);for(n=0;n<a.length;n++)if("JOINT"==a[n].type)for(var o=0;o<a[n].weights.length;o++){var l=a[n].weights[o],h=l.index,c=l.weight,p=e.vertices[h],f=s[h];i.x=p.x,i.y=p.y,i.z=p.z,i.applyMatrix4(a[n].skinningMatrix),f.x+=i.x*c,f.y+=i.y*c,f.z+=i.z*c}for(var n=0;n<e.vertices.length;n++)e.vertices[n]=s[n]}function m(e,t,r){var a=Ge[t.url];if(r=void 0!==r?r:40,!a||!a.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!t.skeleton||!t.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");for(var i=h(),s=He.getChildById(t.skeleton[0],!0)||He.getChildBySid(t.skeleton[0],!0),n=p(s),o=a.skin.joints,l=[],c=0;c<o.length;c++)for(var m=0;m<n.length;m++)n[m].name===o[c]&&(l[c]=n[m]);for(var c=0;c<l.length;c++)for(var m=0;m<l.length;m++)l[c].parent===l[m].name&&(l[c].parent=m);var c,m,E;new THREE.Vector3;for(c=0;c<e.vertices.length;c++)e.vertices[c].applyMatrix4(a.skin.bindShapeMatrix);for(var v=[],g=[],T=a.skin.weights,c=0;c<T.length;c++){var b=new THREE.Vector4(T[c][0]?T[c][0].joint:0,T[c][1]?T[c][1].joint:0,T[c][2]?T[c][2].joint:0,T[c][3]?T[c][3].joint:0),E=new THREE.Vector4(T[c][0]?T[c][0].weight:0,T[c][1]?T[c][1].weight:0,T[c][2]?T[c][2].weight:0,T[c][3]?T[c][3].weight:0);v.push(b),g.push(E)}e.skinIndices=v,e.skinWeights=g,e.bones=l;for(var y={name:i.ID,fps:30,length:i.frames/30,hierarchy:[]},m=0;m<l.length;m++)y.hierarchy.push({parent:l[m].parent,name:l[m].name,keys:[]});for(console.log("ColladaLoader:",i.ID+" has "+l.length+" bones."),f(e,s,a),r=0;r<i.frames;r++){var R=[];u(s,R,r),d(R,a.skin);for(var c=0;c<R.length;c++)for(var m=0;m<y.hierarchy.length;m++)if(y.hierarchy[m].name===R[c].sid){var w={};w.time=r/30,w.matrix=R[c].animatrix,0===r&&(R[c].matrix=w.matrix);var x=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];w.matrix.decompose(x[0],x[1],x[2]),w.pos=[x[0].x,x[0].y,x[0].z],w.scl=[x[2].x,x[2].y,x[2].z],w.rot=x[1],y.hierarchy[m].keys.push(w)}e.animation=y}}function E(){if(Le&&0===Le.joints.length)return void(Se=void 0);var e={},t=function(t,r){var a=r.getAttribute("id"),i=He.getChildById(a,!0),s=Le.joints[t];Pe.traverse(function(r){r.colladaId==a&&(e[t]={node:r,transforms:i.transforms,joint:s,position:s.zeroPosition})})};Se={joints:Le&&Le.joints,getJointValue:function(t){var r=e[t];return r?r.position:void console.log("getJointValue: joint "+t+" doesn't exist")},setJointValue:function(t,r){var i=e[t];if(i){var s=i.joint;if(r>s.limits.max||r<s.limits.min)console.log("setJointValue: joint "+t+" value "+r+" outside of limits (min: "+s.limits.min+", max: "+s.limits.max+")");else if(s.static)console.log("setJointValue: joint "+t+" is static");else{var n=i.node,o=s.axis,l=i.transforms,h=new THREE.Matrix4;for(a=0;a<l.length;a++){var c=l[a];if(c.sid&&c.sid.indexOf("joint"+t)!==-1)switch(s.type){case"revolute":h.multiply(u.makeRotationAxis(o,THREE.Math.degToRad(r)));break;case"prismatic":h.multiply(u.makeTranslation(o.x*r,o.y*r,o.z*r));break;default:console.warn("setJointValue: unknown joint type: "+s.type)}else{var u=new THREE.Matrix4;switch(c.type){case"matrix":h.multiply(c.obj);break;case"translate":h.multiply(u.makeTranslation(c.obj.x,c.obj.y,c.obj.z));break;case"rotate":h.multiply(u.makeRotationAxis(c.obj,c.angle))}}}var d=h.elements,p=Array.prototype.slice.call(d),f=[p[0],p[4],p[8],p[12],p[1],p[5],p[9],p[13],p[2],p[6],p[10],p[14],p[3],p[7],p[11],p[15]];n.matrix.set.apply(n.matrix,f),n.matrix.decompose(n.position,n.quaternion,n.scale)}}else console.log("setJointValue: joint "+t+" doesn't exist")}};var r=je.querySelector("scene instance_kinematics_scene");if(r)for(var a=0;a<r.childNodes.length;a++){var i=r.childNodes[a];if(1==i.nodeType)switch(i.nodeName){case"bind_joint_axis":var s=i.getAttribute("target").split("/").pop(),n=i.querySelector("axis param").textContent,o=parseInt(n.split("joint").pop().split(".")[0]),l=je.querySelector('[sid="'+s+'"]');if(l){var h=l.parentElement;t(o,h)}}}}function v(e,t){var r,a,i,s,n=new THREE.Object3D,o=!1;for(i=0;i<e.controllers.length;i++){var l=Ge[e.controllers[i].url];switch(l.type){case"skin":if(Ye[l.skin.source]){var h=new I;h.url=l.skin.source,h.instance_material=e.controllers[i].instance_material,e.geometries.push(h),o=!0,r=e.controllers[i]}else if(Ge[l.skin.source]){var u=Ge[l.skin.source];if(a=u,u.morph&&Ye[u.morph.source]){var h=new I;h.url=u.morph.source,h.instance_material=e.controllers[i].instance_material,e.geometries.push(h)}}break;case"morph":if(Ye[l.morph.source]){var h=new I;h.url=l.morph.source,h.instance_material=e.controllers[i].instance_material,e.geometries.push(h),a=e.controllers[i]}console.log("ColladaLoader: Morph-controller partially supported.")}}var d={};for(i=0;i<e.geometries.length;i++){var p,f=e.geometries[i],E=f.instance_material,g=Ye[f.url],T={},b=[],y=0;if(g){if(!g.mesh||!g.mesh.primitives)continue;if(0===n.name.length&&(n.name=g.id),E)for(s=0;s<E.length;s++){var R=E[s],w=qe[R.target],x=w.instance_effect.url,A=Xe[x].shader,N=A.material;if(g.doubleSided){if(!(R.symbol in d)){var M=N.clone();M.side=THREE.DoubleSide,d[R.symbol]=M}N=d[R.symbol]}N.opacity=N.opacity?N.opacity:1,T[R.symbol]=y,b.push(N),p=N,p.name=null===w.name||""===w.name?w.id:w.name,y++}var H,L=p||new THREE.MeshLambertMaterial({color:14540253,side:g.doubleSided?THREE.DoubleSide:THREE.FrontSide}),_=g.mesh.geometry3js;if(y>1)for(L=new THREE.MultiMaterial(b),s=0;s<_.faces.length;s++){var S=_.faces[s];S.materialIndex=T[S.daeMaterial]}void 0!==r?(m(_,r),_.morphTargets.length>0?(L.morphTargets=!0,L.skinning=!1):(L.morphTargets=!1,L.skinning=!0),H=new THREE.SkinnedMesh(_,L,!1),H.name="skin_"+Fe.length,Fe.push(H)):void 0!==a?(c(_,a),L.morphTargets=!0,H=new THREE.Mesh(_,L),H.name="morph_"+Ie.length,Ie.push(H)):H=_.isLineStrip===!0?new THREE.Line(_):new THREE.Mesh(_,L),n.add(H)}}for(i=0;i<e.cameras.length;i++){var k=e.cameras[i],O=ze[k.url],C=new THREE.PerspectiveCamera(O.yfov,parseFloat(O.aspect_ratio),parseFloat(O.znear),parseFloat(O.zfar));n.add(C)}for(i=0;i<e.lights.length;i++){var F=null,j=e.lights[i],P=We[j.url];if(P&&P.technique){var U=P.color.getHex(),B=P.intensity,D=P.distance,V=P.falloff_angle;switch(P.technique){case"directional":F=new THREE.DirectionalLight(U,B,D),F.position.set(0,0,1);break;case"point":F=new THREE.PointLight(U,B,D);break;case"spot":F=new THREE.SpotLight(U,B,D,V),F.position.set(0,0,1);break;case"ambient":F=new THREE.AmbientLight(U)}}F&&n.add(F)}if(n.name=e.name||e.id||"",n.colladaId=e.id||"",n.layer=e.layer||"",n.matrix=e.matrix,n.matrix.decompose(n.position,n.quaternion,n.scale),Ke.centerGeometry&&n.geometry){var G=n.geometry.center();G.multiply(n.scale),G.applyQuaternion(n.quaternion),n.position.sub(G)}for(i=0;i<e.nodes.length;i++)n.add(v(e.nodes[i],e));return n}function g(e){for(var t=je.querySelectorAll("library_nodes node"),r=0;r<t.length;r++){var a=t[r].attributes.getNamedItem("id");if(a&&a.value===e)return t[r]}}function T(e){var t=[],r=1e6,a=-1e6;for(var i in Ve)for(var s=Ve[i],n=0;n<s.channel.length;n++){var o=s.channel[n],l=s.sampler[n],i=o.target.split("/")[0];i==e.id&&(l.create(),o.sampler=l,r=Math.min(r,l.startTime),a=Math.max(a,l.endTime),t.push(o))}return t.length&&(e.startTime=r,e.endTime=a),t}function b(e){if(e.channels&&e.channels.length){for(var t=[],r=[],a=0,i=e.channels.length;a<i;a++){var s,n=e.channels[a],o=n.fullSid,l=n.sampler,h=l.input,c=e.getTransformBySid(n.sid);if(n.arrIndices){s=[];for(var u=0,d=n.arrIndices.length;u<d;u++)s[u]=Ne(n.arrIndices[u])}else s=Me(n.member);if(c){r.indexOf(o)===-1&&r.push(o);for(var u=0,d=h.length;u<d;u++){var p=h[u],f=l.getData(c.type,u,s),m=y(t,p);if(!m){m=new re(p);var E=R(t,p);t.splice(E===-1?t.length:E,0,m)}m.addTarget(o,c,s,f)}}else console.log('Could not find transform "'+n.sid+'" in node '+e.id)}for(var a=0;a<r.length;a++)for(var v=r[a],u=0;u<t.length;u++){var m=t[u];m.hasTarget(v)||w(t,m,u,v)}e.keys=t,e.sids=r}}function y(e,t){for(var r=null,a=0,i=e.length;a<i&&null===r;a++){var s=e[a];if(s.time===t)r=s;else if(s.time>t)break}return r}function R(e,t){for(var r=-1,a=0,i=e.length;a<i&&r===-1;a++){var s=e[a];s.time>=t&&(r=a)}return r}function w(e,t,r,a){var i=A(e,a,r?r-1:0),s=x(e,a,r+1);if(i&&s){var n,o=(t.time-i.time)/(s.time-i.time),l=i.getTarget(a),h=s.getTarget(a).data,c=l.data;if("matrix"===l.type)n=c;else if(c.length){n=[];for(var u=0;u<c.length;++u)n[u]=c[u]+(h[u]-c[u])*o}else n=c+(h-c)*o;t.addTarget(a,l.transform,l.member,n)}}function x(e,t,r){for(;r<e.length;r++){var a=e[r];if(a.hasTarget(t))return a}return null}function A(e,t,r){for(r=r>=0?r:r+e.length;r>=0;r--){var a=e[r];if(a.hasTarget(t))return a}return null}function N(){this.id="",this.init_from=""}function M(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function H(){this.method=null,this.source=null,this.targets=null,this.weights=null}function L(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function _(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function S(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function k(){this.sid="",this.type="",this.data=[],this.obj=null}function O(){this.url="",this.skeleton=[],this.instance_material=[]}function C(){this.symbol="",this.target=""}function I(){this.url="",this.instance_material=[]}function F(){this.id="",this.mesh=null}function j(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function P(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function U(){P.call(this),this.vcount=[]}function B(){P.call(this),this.vcount=1}function D(){P.call(this),this.vcount=3}function V(){this.source="",this.count=0,this.stride=0,this.params=[]}function G(){this.input={}}function Y(){this.semantic="",this.offset=0,this.source="",this.set=0}function q(e){this.id=e,this.type=null}function X(){this.id="",this.name="",this.instance_effect=null}function z(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function W(e,t){this.type=e,this.effect=t,this.material=null}function Z(e){this.effect=e,this.init_from=null,this.format=null}function K(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function J(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function Q(){this.url=""}function $(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function ee(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function te(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function re(e){this.targets=[],this.time=e}function ae(){this.id="",this.name="",this.technique=""}function ie(){this.url=""}function se(){this.id="",this.name="",this.technique=""}function ne(){
this.url=""}function oe(){this.id="",this.name="",this.joints=[],this.links=[]}function le(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0}function he(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function ce(){this.joint="",this.transforms=[],this.links=[]}function ue(e){var t=e.getAttribute("id");return void 0!=Be[t]?Be[t]:(Be[t]=new q(t).parse(e),Be[t])}function de(e){for(var t=me(e),r=[],a=0,i=t.length;a<i;a++)r.push("true"===t[a]||"1"===t[a]);return r}function pe(e){for(var t=me(e),r=[],a=0,i=t.length;a<i;a++)r.push(parseFloat(t[a]));return r}function fe(e){for(var t=me(e),r=[],a=0,i=t.length;a<i;a++)r.push(parseInt(t[a],10));return r}function me(e){return e.length>0?Ee(e).split(/\s+/):[]}function Ee(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function ve(e,t,r){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):r}function ge(e,t){if("string"!=typeof e||""===e)return"";if(/^(https?:)?\/\//i.test(e))return e;if(/^data:.*,.*$/i.test(e))return e;var r=new URL((t||"")+e,location.href.substring(0,location.href.lastIndexOf("/")+1));return r.toString()}function Te(e,t){var r=new THREE.ImageLoader;r.load(t,function(t){e.image=t,e.needsUpdate=!0})}function be(e,t){e.doubleSided=!1;var r=t.querySelectorAll("extra double_sided")[0];r&&r&&1===parseInt(r.textContent,10)&&(e.doubleSided=!0)}function ye(){if(Ke.convertUpAxis!==!0||Qe===Ke.upAxis)$e=null;else switch(Qe){case"X":$e="Y"===Ke.upAxis?"XtoY":"XtoZ";break;case"Y":$e="X"===Ke.upAxis?"YtoX":"YtoZ";break;case"Z":$e="X"===Ke.upAxis?"ZtoX":"ZtoY"}}function Re(e,t){if(Ke.convertUpAxis===!0&&Qe!==Ke.upAxis)switch($e){case"XtoY":var r=e[0];e[0]=t*e[1],e[1]=r;break;case"XtoZ":var r=e[2];e[2]=e[1],e[1]=e[0],e[0]=r;break;case"YtoX":var r=e[0];e[0]=e[1],e[1]=t*r;break;case"YtoZ":var r=e[1];e[1]=t*e[2],e[2]=r;break;case"ZtoX":var r=e[0];e[0]=e[1],e[1]=e[2],e[2]=r;break;case"ZtoY":var r=e[1];e[1]=e[2],e[2]=t*r}}function we(e,t){if(Ke.convertUpAxis!==!0||Qe===Ke.upAxis)return t;switch(e){case"X":t="XtoY"===$e?t*-1:t;break;case"Y":t="YtoZ"===$e||"YtoX"===$e?t*-1:t;break;case"Z":t="ZtoY"===$e?t*-1:t}return t}function xe(e,t){var r=[e[t],e[t+1],e[t+2]];return Re(r,-1),new THREE.Vector3(r[0],r[1],r[2])}function Ae(e){if(Ke.convertUpAxis){var t=[e[0],e[4],e[8]];Re(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],t=[e[1],e[5],e[9]],Re(t,-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],t=[e[2],e[6],e[10]],Re(t,-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],t=[e[0],e[1],e[2]],Re(t,-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],t=[e[4],e[5],e[6]],Re(t,-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],t=[e[8],e[9],e[10]],Re(t,-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],t=[e[3],e[7],e[11]],Re(t,-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function Ne(e){if(e>-1&&e<3){var t=["X","Y","Z"],r={X:0,Y:1,Z:2};e=Me(t[e]),e=r[e]}return e}function Me(e){if(Ke.convertUpAxis)switch(e){case"X":switch($e){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch($e){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch($e){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}var He,Le,_e,Se,ke,Oe,Ce,Ie,Fe,je=null,Pe=null,Ue=null,Be={},De={},Ve={},Ge={},Ye={},qe={},Xe={},ze={},We={},Ze=THREE.SmoothShading,Ke={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},Je=1,Qe="Y",$e=null;return N.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];"init_from"===r.nodeName&&(this.init_from=r.textContent)}return this},M.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"skin":this.skin=(new L).parse(r),this.type=r.nodeName;break;case"morph":this.morph=(new H).parse(r),this.type=r.nodeName}}return this},H.prototype.parse=function(e){var t,r={},a=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"source":var s=(new q).parse(i);r[s.id]=s;break;case"targets":a=this.parseInputs(i);break;default:console.log(i.nodeName)}}for(t=0;t<a.length;t++){var n=a[t],s=r[n.source];switch(n.semantic){case"MORPH_TARGET":this.targets=s.read();break;case"MORPH_WEIGHT":this.weights=s.read()}}return this},H.prototype.parseInputs=function(e){for(var t=[],r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"input":t.push((new Y).parse(a))}}return t},L.prototype.parse=function(e){var t,r,a={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(1==s.nodeType)switch(s.nodeName){case"bind_shape_matrix":var n=pe(s.textContent);this.bindShapeMatrix=Ae(n);break;case"source":var o=(new q).parse(s);a[o.id]=o;break;case"joints":t=s;break;case"vertex_weights":r=s;break;default:console.log(s.nodeName)}}return this.parseJoints(t,a),this.parseWeights(r,a),this},L.prototype.parseJoints=function(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"input":var i=(new Y).parse(a),s=t[i.source];"JOINT"===i.semantic?this.joints=s.read():"INV_BIND_MATRIX"===i.semantic&&(this.invBindMatrices=s.read())}}},L.prototype.parseWeights=function(e,t){for(var r,a,i=[],s=0;s<e.childNodes.length;s++){var n=e.childNodes[s];if(1==n.nodeType)switch(n.nodeName){case"input":i.push((new Y).parse(n));break;case"v":r=fe(n.textContent);break;case"vcount":a=fe(n.textContent)}}for(var o=0,s=0;s<a.length;s++){for(var l=a[s],h=[],c=0;c<l;c++){for(var u={},d=0;d<i.length;d++){var p=i[d],f=r[o+p.offset];switch(p.semantic){case"JOINT":u.joint=f;break;case"WEIGHT":u.weight=t[p.source].data[f]}}h.push(u),o+=i.length}for(var c=0;c<h.length;c++)h[c].index=s;this.weights.push(h)}},_.prototype.getChildById=function(e,t){for(var r=0;r<this.nodes.length;r++){var a=this.nodes[r].getChildById(e,t);if(a)return a}return null},_.prototype.getChildBySid=function(e,t){for(var r=0;r<this.nodes.length;r++){var a=this.nodes[r].getChildBySid(e,t);if(a)return a}return null},_.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"node":this.nodes.push((new S).parse(r))}}return this},S.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var r,a,i=this.channels[t],s=i.target.split("/"),n=(s.shift(),s.shift()),o=n.indexOf(".")>=0,l=n.indexOf("(")>=0;if(o)s=n.split("."),n=s.shift(),a=s.shift();else if(l){r=n.split("("),n=r.shift();for(var h=0;h<r.length;h++)r[h]=parseInt(r[h].replace(/\)/,""))}if(n===e)return i.info={sid:n,dotSyntax:o,arrSyntax:l,arrIndices:r},i}return null},S.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(var r=0;r<this.nodes.length;r++){var a=this.nodes[r].getChildById(e,t);if(a)return a}return null},S.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(var r=0;r<this.nodes.length;r++){var a=this.nodes[r].getChildBySid(e,t);if(a)return a}return null},S.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},S.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"node":this.nodes.push((new S).parse(a));break;case"instance_camera":this.cameras.push((new ie).parse(a));break;case"instance_controller":this.controllers.push((new O).parse(a));break;case"instance_geometry":this.geometries.push((new I).parse(a));break;case"instance_light":this.lights.push((new ne).parse(a));break;case"instance_node":t=a.getAttribute("url").replace(/^#/,"");var i=g(t);i&&this.nodes.push((new S).parse(i));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new k).parse(a));break;case"extra":break;default:console.log(a.nodeName)}}return this.channels=T(this),b(this),this.updateMatrix(),this},S.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},k.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=pe(e.textContent),this.convert(),this},k.prototype.convert=function(){switch(this.type){case"matrix":this.obj=Ae(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":Re(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":Re(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},k.prototype.apply=function(){var e=new THREE.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),k.prototype.update=function(e,t){var r=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){var a="n"+(t[0]+1)+(t[1]+1);this.obj[a]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=r[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=r[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE.Math.degToRad(e[3])}}},O.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1===r.nodeType)switch(r.nodeName){case"skeleton":this.skeleton.push(r.textContent.replace(/^#/,""));break;case"bind_material":for(var a=r.querySelectorAll("instance_material"),i=0;i<a.length;i++){var s=a[i];this.instance_material.push((new C).parse(s))}break;case"extra":}}return this},C.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},I.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType&&"bind_material"===r.nodeName){for(var a=r.querySelectorAll("instance_material"),i=0;i<a.length;i++){var s=a[i];this.instance_material.push((new C).parse(s))}break}}return this},F.prototype.parse=function(e){this.id=e.getAttribute("id"),be(this,e);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"mesh":this.mesh=new j(this).parse(r);break;case"extra":}}return this},j.prototype.parse=function(e){this.primitives=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"source":ue(r);break;case"vertices":this.vertices=(new G).parse(r);break;case"linestrips":this.primitives.push((new B).parse(r));break;case"triangles":this.primitives.push((new D).parse(r));break;case"polygons":this.primitives.push((new P).parse(r));break;case"polylist":this.primitives.push((new U).parse(r))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;for(var a=Be[this.vertices.input.POSITION.source].data,t=0;t<a.length;t+=3)this.geometry3js.vertices.push(xe(a,t).clone());for(var t=0;t<this.primitives.length;t++){var i=this.primitives[t];i.setVertices(this.vertices),this.handlePrimitive(i,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},j.prototype.handlePrimitive=function(e,t){if(e instanceof B)return void(t.isLineStrip=!0);var r,a,i,s,n,o,l,h=e.p,c=e.inputs,u=0,d=3,p=0,f=[];for(r=0;r<c.length;r++){i=c[r];var m=i.offset+1;switch(p=p<m?m:p,i.semantic){case"TEXCOORD":f.push(i.set)}}for(var E=0;E<h.length;++E)for(var v=h[E],g=0;g<v.length;){var T=[],b=[],y=null,R=[];for(d=e.vcount?e.vcount.length?e.vcount[u++]:e.vcount:v.length/p,r=0;r<d;r++)for(a=0;a<c.length;a++)switch(i=c[a],o=Be[i.source],s=v[g+r*p+i.offset],l=o.accessor.params.length,n=s*l,i.semantic){case"VERTEX":T.push(s);break;case"NORMAL":b.push(xe(o.data,n));break;case"TEXCOORD":y=y||{},void 0===y[i.set]&&(y[i.set]=[]),y[i.set].push(new THREE.Vector2(o.data[n],o.data[n+1]));break;case"COLOR":R.push((new THREE.Color).setRGB(o.data[n],o.data[n+1],o.data[n+2]))}if(0===b.length)if(i=this.vertices.input.NORMAL){o=Be[i.source],l=o.accessor.params.length;for(var w=0,x=T.length;w<x;w++)b.push(xe(o.data,T[w]*l))}else t.calcNormals=!0;if(!y&&(y={},i=this.vertices.input.TEXCOORD)){f.push(i.set),o=Be[i.source],l=o.accessor.params.length;for(var w=0,x=T.length;w<x;w++)n=T[w]*l,void 0===y[i.set]&&(y[i.set]=[]),y[i.set].push(new THREE.Vector2(o.data[n],1-o.data[n+1]))}if(0===R.length&&(i=this.vertices.input.COLOR)){o=Be[i.source],l=o.accessor.params.length;for(var w=0,x=T.length;w<x;w++)n=T[w]*l,R.push((new THREE.Color).setRGB(o.data[n],o.data[n+1],o.data[n+2]))}var A,N,M=null,H=[];if(3===d)H.push(new THREE.Face3(T[0],T[1],T[2],b,R.length?R:new THREE.Color));else if(4===d)H.push(new THREE.Face3(T[0],T[1],T[3],b.length?[b[0].clone(),b[1].clone(),b[3].clone()]:[],R.length?[R[0],R[1],R[3]]:new THREE.Color)),H.push(new THREE.Face3(T[1],T[2],T[3],b.length?[b[1].clone(),b[2].clone(),b[3].clone()]:[],R.length?[R[1],R[2],R[3]]:new THREE.Color));else if(d>4&&Ke.subdivideFaces){var L=R.length?R:new THREE.Color;for(a=1;a<d-1;)H.push(new THREE.Face3(T[0],T[a],T[a+1],b.length?[b[0].clone(),b[a++].clone(),b[a].clone()]:[],L))}if(H.length)for(var w=0,x=H.length;w<x;w++)for(M=H[w],M.daeMaterial=e.material,t.faces.push(M),a=0;a<f.length;a++)A=y[f[a]],N=d>4?[A[0],A[w+1],A[w+2]]:4===d?0===w?[A[0],A[1],A[3]]:[A[1].clone(),A[2],A[3].clone()]:[A[0],A[1],A[2]],void 0===t.faceVertexUvs[a]&&(t.faceVertexUvs[a]=[]),t.faceVertexUvs[a].push(N);else console.log("dropped face with vcount "+d+" for geometry with id: "+t.id);g+=p*d}},P.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},P.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=ve(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"input":this.inputs.push((new Y).parse(e.childNodes[t]));break;case"vcount":this.vcount=fe(r.textContent);break;case"p":this.p.push(fe(r.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},U.prototype=Object.create(P.prototype),U.prototype.constructor=U,B.prototype=Object.create(P.prototype),B.prototype.constructor=B,D.prototype=Object.create(P.prototype),D.prototype.constructor=D,V.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=ve(e,"count",0),this.stride=ve(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if("param"===r.nodeName){var a={};a.name=r.getAttribute("name"),a.type=r.getAttribute("type"),this.params.push(a)}}return this},G.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){var r=(new Y).parse(e.childNodes[t]);this.input[r.semantic]=r}return this},Y.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=ve(e,"set",-1),this.offset=ve(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},q.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"bool_array":this.data=de(r.textContent),this.type=r.nodeName;break;case"float_array":this.data=pe(r.textContent),this.type=r.nodeName;break;case"int_array":this.data=fe(r.textContent),this.type=r.nodeName;break;case"IDREF_array":case"Name_array":this.data=me(r.textContent),this.type=r.nodeName;break;case"technique_common":for(var a=0;a<r.childNodes.length;a++)if("accessor"===r.childNodes[a].nodeName){this.accessor=(new V).parse(r.childNodes[a]);break}}}return this},q.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var r=0;r<this.data.length;r+=16){var a=this.data.slice(r,r+16),i=Ae(a);e.push(i)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},X.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new Q).parse(e.childNodes[t]);break}return this},z.prototype.isColor=function(){return null===this.texture},z.prototype.isTexture=function(){return null!=this.texture},z.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"color":var a=pe(r.textContent);this.color=new THREE.Color,this.color.setRGB(a[0],a[1],a[2]),this.color.a=a[3];break;case"texture":this.texture=r.getAttribute("texture"),this.texcoord=r.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(r)}}return this},z.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1],e.childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]));for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[r.nodeName]=parseFloat(r.textContent);break;case"wrapU":case"wrapV":"TRUE"===r.textContent.toUpperCase()?this.texOpts[r.nodeName]=1:this.texOpts[r.nodeName]=parseInt(r.textContent);break;default:this.texOpts[r.nodeName]=r.textContent}}return this},W.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[r.nodeName]=(new z).parse(r);break;case"bump":var a=r.getAttribute("bumptype");a?"heightfield"===a.toLowerCase()?this.bump=(new z).parse(r):"normalmap"===a.toLowerCase()?this.normal=(new z).parse(r):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+a+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new z).parse(r)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new z).parse(r));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var i=r.querySelectorAll("float");i.length>0&&(this[r.nodeName]=parseFloat(i[0].textContent))}}return this.create(),this},W.prototype.create=function(){var e={},t=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var r=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);r>0&&(t=!0,e.transparent=!0,e.opacity=1-r)}var a={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var i in this)switch(i){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var s=this[i];if(s instanceof z)if(s.isTexture()){var n=s.texture,o=this.effect.sampler[n];if(void 0!==o&&void 0!==o.source){var l=this.effect.surface[o.source];if(void 0!==l){var h=De[l.init_from];if(h){var c,u=Ce+h.init_from;if(altspace&&altspace.inClient)c=new THREE.Texture({src:ge(u)});else{var d=THREE.Loader.Handlers.get(u);null!==d?c=d.load(u):(c=new THREE.Texture,Te(c,u))}"MIRROR"===o.wrap_s?c.wrapS=THREE.MirroredRepeatWrapping:"WRAP"===o.wrap_s||s.texOpts.wrapU?c.wrapS=THREE.RepeatWrapping:c.wrapS=THREE.ClampToEdgeWrapping,"MIRROR"===o.wrap_t?c.wrapT=THREE.MirroredRepeatWrapping:"WRAP"===o.wrap_t||s.texOpts.wrapV?c.wrapT=THREE.RepeatWrapping:c.wrapT=THREE.ClampToEdgeWrapping,c.offset.x=s.texOpts.offsetU,c.offset.y=s.texOpts.offsetV,c.repeat.x=s.texOpts.repeatU,c.repeat.y=s.texOpts.repeatV,e[a[i]]=c,"emission"===i&&(e.emissive=16777215)}}}}else"diffuse"!==i&&t||("emission"===i?e.emissive=s.color.getHex():e[i]=s.color.getHex());break;case"shininess":e[i]=this[i];break;case"reflectivity":e[i]=this[i],e[i]>0&&(e.envMap=Ke.defaultEnvMap),e.combine=THREE.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[i],1!==this[i]&&(e.envMap=Ke.defaultEnvMap);break;case"transparency":}switch(e.shading=Ze,e.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,void 0!==e.diffuse&&(e.color=e.diffuse,delete e.diffuse),this.type){case"constant":void 0!=e.emissive&&(e.color=e.emissive),this.material=new THREE.MeshBasicMaterial(e);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(e);break;case"lambert":default:this.material=new THREE.MeshLambertMaterial(e)}return this.material},Z.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"init_from":this.init_from=r.textContent;break;case"format":this.format=r.textContent;break;default:console.log("unhandled Surface prop: "+r.nodeName)}}return this},K.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"source":this.source=r.textContent;break;case"minfilter":this.minfilter=r.textContent;break;case"magfilter":this.magfilter=r.textContent;break;case"mipfilter":this.mipfilter=r.textContent;break;case"wrap_s":this.wrap_s=r.textContent;break;case"wrap_t":this.wrap_t=r.textContent;break;default:console.log("unhandled Sampler2D prop: "+r.nodeName)}}return this},J.prototype.create=function(){if(null===this.shader)return null},J.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),be(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(r))}}return this},J.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"surface":this.surface[t]=new Z(this).parse(a);break;case"sampler2D":this.sampler[t]=new K(this).parse(a);break;case"extra":break;default:console.log(a.nodeName)}}},J.prototype.parseProfileCOMMON=function(e){for(var t,r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"profile_COMMON":this.parseProfileCOMMON(a);break;case"technique":t=a;break;case"newparam":this.parseNewparam(a);break;case"image":var i=(new N).parse(a);De[i.id]=i;break;case"extra":break;default:console.log(a.nodeName)}}return t},J.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new W(r.nodeName,this).parse(r);break;case"extra":this.parseExtra(r)}}},J.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"technique":this.parseExtraTechnique(r)}}},J.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"bump":this.shader.parse(e)}}},Q.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},$.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"animation":var a=(new $).parse(r);for(var i in a.source)this.source[i]=a.source[i];for(var s=0;s<a.channel.length;s++)this.channel.push(a.channel[s]),this.sampler.push(a.sampler[s]);break;case"source":var i=(new q).parse(r);this.source[i.id]=i;break;case"sampler":this.sampler.push(new te(this).parse(r));break;case"channel":this.channel.push(new ee(this).parse(r))}}return this},ee.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),r=(t.shift(),t.shift()),a=r.indexOf(".")>=0,i=r.indexOf("(")>=0;if(a)t=r.split("."),this.sid=t.shift(),this.member=t.shift();else if(i){var s=r.split("(");this.sid=s.shift();for(var n=0;n<s.length;n++)s[n]=parseInt(s[n].replace(/\)/,""));this.arrIndices=s}else this.sid=r;return this.fullSid=r,this.dotSyntax=a,this.arrSyntax=i,this},te.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"input":this.inputs.push((new Y).parse(r))}}return this},te.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],r=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=r.read();break;case"OUTPUT":this.output=r.read(),this.strideOut=r.accessor.stride;break;case"INTERPOLATION":this.interpolation=r.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},te.prototype.getData=function(e,t,r){var a;if("matrix"===e&&16===this.strideOut)a=this.output[t];else if(this.strideOut>1){a=[],t*=this.strideOut;for(var i=0;i<this.strideOut;++i)a[i]=this.output[t+i];if(3===this.strideOut)switch(e){case"rotate":case"translate":Re(a,-1);break;case"scale":Re(a,1)}else 4===this.strideOut&&"matrix"===e&&Re(a,-1)}else a=this.output[t],r&&"translate"===e&&(a=we(r,a));return a},re.prototype.addTarget=function(e,t,r,a){this.targets.push({sid:e,member:r,transform:t,data:a})},re.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var r=this.targets[t];e&&r.sid!==e||r.transform.update(r.data,r.member)}},re.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},re.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},re.prototype.interpolate=function(e,t){for(var r=0,a=this.targets.length;r<a;r++){var i,s=this.targets[r],n=e.getTarget(s.sid);if("matrix"!==s.transform.type&&n){var o=(t-this.time)/(e.time-this.time),l=n.data,h=s.data;if(o<0&&(o=0),o>1&&(o=1),h.length){i=[];for(var c=0;c<h.length;++c)i[c]=h[c]+(l[c]-h[c])*o}else i=h+(l-h)*o}else i=s.data;s.transform.update(i,s.member)}},ae.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"optics":this.parseOptics(r)}}return this},ae.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if("technique_common"===e.childNodes[t].nodeName)for(var r=e.childNodes[t],a=0;a<r.childNodes.length;a++)if(this.technique=r.childNodes[a].nodeName,"perspective"===this.technique)for(var i=r.childNodes[a],s=0;s<i.childNodes.length;s++){var n=i.childNodes[s];switch(n.nodeName){case"yfov":this.yfov=n.textContent;break;case"xfov":this.xfov=n.textContent;break;case"znear":this.znear=n.textContent;break;case"zfar":this.zfar=n.textContent;break;case"aspect_ratio":this.aspect_ratio=n.textContent}}else if("orthographic"===this.technique)for(var o=r.childNodes[a],s=0;s<o.childNodes.length;s++){var n=o.childNodes[s];switch(n.nodeName){case"xmag":this.xmag=n.textContent;break;case"ymag":this.ymag=n.textContent;break;case"znear":this.znear=n.textContent;break;case"zfar":this.zfar=n.textContent;break;case"aspect_ratio":this.aspect_ratio=n.textContent}}return this},ie.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},se.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"technique_common":this.parseCommon(r);break;case"technique":this.parseTechnique(r)}}return this},se.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;for(var r=e.childNodes[t],a=0;a<r.childNodes.length;a++){var i=r.childNodes[a];switch(i.nodeName){case"color":var s=pe(i.textContent);this.color=new THREE.Color(0),this.color.setRGB(s[0],s[1],s[2]),this.color.a=s[3];break;case"falloff_angle":this.falloff_angle=parseFloat(i.textContent);break;case"quadratic_attenuation":var n=parseFloat(i.textContent);this.distance=n?Math.sqrt(1/n):0}}}return this},se.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"intensity":this.intensity=parseFloat(r.textContent)}}return this},ne.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},oe.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"technique_common":this.parseCommon(r)}}return this},oe.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new le).parse(r));break;case"link":this.links.push((new he).parse(r))}}return this},le.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0;var t=e.querySelector("axis"),r=pe(t.textContent);this.axis=xe(r,0);var a=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,i=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:a,max:i};for(var s=["prismatic","revolute"],n=0;n<s.length;n++){var o=s[n],l=e.querySelector(o);l&&(this.type=o)}return this.limits.min>=this.limits.max&&(this.static=!0),
this.middlePosition=(this.limits.min+this.limits.max)/2,this},he.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"attachment_full":this.attachments.push((new ce).parse(r));break;case"rotate":case"translate":case"matrix":this.transforms.push((new k).parse(r))}}return this},ce.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"link":this.links.push((new he).parse(r));break;case"rotate":case"translate":case"matrix":this.transforms.push((new k).parse(r))}}return this},{load:e,parse:t,setPreferredShading:r,applySkin:m,geometries:Ye,options:Ke}},THREE.GLTFLoader=function(){function e(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}function t(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}},update:function(t,r){for(var a in e){var i=e[a];i.update&&i.update(t,r)}}}}function r(e,t){var r={},a=e.material.uniforms;for(var i in a){var s=a[i];if(s.semantic){var n=s.node,o=e;n&&(o=t[n]),r[i]={semantic:s.semantic,sourceNode:o,targetNode:e,uniform:s}}}this.boundUniforms=r,this._m4=new THREE.Matrix4}function a(e){this.name=u.KHR_MATERIALS_COMMON,this.lights={};var t=e.extensions&&e.extensions[u.KHR_MATERIALS_COMMON]||{},r=t.lights||{};for(var a in r){var i,s=r[a],n=s[s.type],o=(new THREE.Color).fromArray(n.color);switch(s.type){case"directional":i=new THREE.DirectionalLight(o),i.position.set(0,0,1);break;case"point":i=new THREE.PointLight(o);break;case"spot":i=new THREE.SpotLight(o),i.position.set(0,0,1);break;case"ambient":i=new THREE.AmbientLight(o)}i&&(this.lights[a]=i)}}function i(e){this.name=u.KHR_BINARY_GLTF;var t=new DataView(e,0,f),r={magic:o(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0),contentLength:t.getUint32(12,!0),contentFormat:t.getUint32(16,!0)};for(var a in p){var i=p[a];if(r[a]!==i)throw new Error('Unsupported glTF-Binary header: Expected "%s" to be "%s".',a,i)}var s=new Uint8Array(e,f,r.contentLength);this.header=r,this.content=o(s),this.body=e.slice(f+r.contentLength,r.length)}function s(e,t,r){if(!e)return Promise.resolve();var a,i=[];if("[object Array]"===Object.prototype.toString.call(e)){a=[];for(var s=e.length,n=0;n<s;n++){var o=t.call(r||this,e[n],n);o&&(i.push(o),o instanceof Promise?o.then(function(e,t){a[e]=t}.bind(this,n)):a[n]=o)}}else{a={};for(var l in e)if(e.hasOwnProperty(l)){var o=t.call(r||this,e[l],l);o&&(i.push(o),o instanceof Promise?o.then(function(e,t){a[e]=t}.bind(this,l)):a[l]=o)}}return Promise.all(i).then(function(){return a})}function n(e,t){if("string"!=typeof e||""===e)return"";if(/^(https?:)?\/\//i.test(e))return e;if(/^data:.*,.*$/i.test(e))return e;var r=new URL((t||"")+e,location.href.substring(0,location.href.lastIndexOf("/")+1));return r.toString()}function o(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}function l(){return new THREE.MeshPhongMaterial({color:0,emissive:8947848,specular:0,shininess:0,transparent:!1,depthTest:!0,side:THREE.FrontSide})}function h(e){this.isDeferredShaderMaterial=!0,this.params=e}function c(e,r,a){this.json=e||{},this.extensions=r||{},this.options=a||{},this.cache=new t}e.prototype={constructor:e,load:function(e,t,r,a){var i=this,s=this.path&&"string"==typeof this.path?this.path:THREE.Loader.prototype.extractUrlBase(e),n=new THREE.FileLoader(i.manager);n.setResponseType("arraybuffer"),n.load(e,function(e){i.parse(e,t,s)},r,a)},setCrossOrigin:function(e){this.crossOrigin=e},setPath:function(e){this.path=e},parse:function(e,t,r){var s,n={},l=o(new Uint8Array(e,0,4));l===p.magic?(n[u.KHR_BINARY_GLTF]=new i(e),s=n[u.KHR_BINARY_GLTF].content):s=o(new Uint8Array(e));var h=JSON.parse(s);h.extensionsUsed&&h.extensionsUsed.indexOf(u.KHR_MATERIALS_COMMON)>=0&&(n[u.KHR_MATERIALS_COMMON]=new a(h)),console.time("GLTFLoader");var d=new c(h,n,{path:r||this.path,crossOrigin:this.crossOrigin});d.parse(function(e,r,a,i){console.log("------------ UltimateLoader ---------------"),console.timeEnd("GLTFLoader");var s={scene:e,scenes:r,cameras:a,animations:i};t(s)})}},e.Shaders={update:function(){console.warn("THREE.GLTFLoader.Shaders has been deprecated, and now updates automatically.")}},r.prototype.update=function(e,t){var r=this.boundUniforms;for(var a in r){var i=r[a];switch(i.semantic){case"MODELVIEW":var s=i.uniform.value;s.multiplyMatrices(t.matrixWorldInverse,i.sourceNode.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var n=i.uniform.value;this._m4.multiplyMatrices(t.matrixWorldInverse,i.sourceNode.matrixWorld),n.getNormalMatrix(this._m4);break;case"PROJECTION":var s=i.uniform.value;s.copy(t.projectionMatrix);break;case"JOINTMATRIX":for(var o=i.uniform.value,l=0;l<o.length;l++)o[l].getInverse(i.sourceNode.matrixWorld).multiply(i.targetNode.skeleton.bones[l].matrixWorld).multiply(i.targetNode.skeleton.boneInverses[l]).multiply(i.targetNode.bindMatrix);break;default:console.warn("Unhandled shader semantic: "+i.semantic)}}},e.Animations={update:function(){console.warn("THREE.GLTFLoader.Animation has been deprecated. Use THREE.AnimationMixer instead.")}};var u={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_MATERIALS_COMMON:"KHR_materials_common"},d="binary_glTF",p={magic:"glTF",version:1,contentFormat:0},f=20;i.prototype.loadShader=function(e,t){var r=t[e.extensions[u.KHR_BINARY_GLTF].bufferView],a=new Uint8Array(r);return o(a)},i.prototype.loadTextureSourceUri=function(e,t){var r=e.extensions[u.KHR_BINARY_GLTF],a=t[r.bufferView],i=o(new Uint8Array(a));return"data:"+r.mimeType+";base64,"+btoa(i)};var m={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,TRIANGLES:4,LINES:1,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,VERTEX_SHADER:35633,FRAGMENT_SHADER:35632},E=({5126:Number,35675:THREE.Matrix3,35676:THREE.Matrix4,35664:THREE.Vector2,35665:THREE.Vector3,35666:THREE.Vector4,35678:THREE.Texture},{5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),v={9728:THREE.NearestFilter,9729:THREE.LinearFilter,9984:THREE.NearestMipMapNearestFilter,9985:THREE.LinearMipMapNearestFilter,9986:THREE.NearestMipMapLinearFilter,9987:THREE.LinearMipMapLinearFilter},g={33071:THREE.ClampToEdgeWrapping,33648:THREE.MirroredRepeatWrapping,10497:THREE.RepeatWrapping},T={6406:THREE.AlphaFormat,6407:THREE.RGBFormat,6408:THREE.RGBAFormat,6409:THREE.LuminanceFormat,6410:THREE.LuminanceAlphaFormat},b={5121:THREE.UnsignedByteType,32819:THREE.UnsignedShort4444Type,32820:THREE.UnsignedShort5551Type,33635:THREE.UnsignedShort565Type},y=({1028:THREE.BackSide,1029:THREE.FrontSide},{512:THREE.NeverDepth,513:THREE.LessDepth,514:THREE.EqualDepth,515:THREE.LessEqualDepth,516:THREE.GreaterEqualDepth,517:THREE.NotEqualDepth,518:THREE.GreaterEqualDepth,519:THREE.AlwaysDepth},{32774:THREE.AddEquation,32778:THREE.SubtractEquation,32779:THREE.ReverseSubtractEquation},{0:THREE.ZeroFactor,1:THREE.OneFactor,768:THREE.SrcColorFactor,769:THREE.OneMinusSrcColorFactor,770:THREE.SrcAlphaFactor,771:THREE.OneMinusSrcAlphaFactor,772:THREE.DstAlphaFactor,773:THREE.OneMinusDstAlphaFactor,774:THREE.DstColorFactor,775:THREE.OneMinusDstColorFactor,776:THREE.SrcAlphaSaturateFactor},{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}),R={scale:"scale",translation:"position",rotation:"quaternion"},w={LINEAR:THREE.InterpolateLinear,STEP:THREE.InterpolateDiscrete};return h.prototype.create=function(){var e=THREE.UniformsUtils.clone(this.params.uniforms);for(var t in this.params.uniforms){var r=this.params.uniforms[t];r.value instanceof THREE.Texture&&(e[t].value=r.value,e[t].value.needsUpdate=!0),e[t].semantic=r.semantic,e[t].node=r.node}return this.params.uniforms=e,new THREE.RawShaderMaterial(this.params)},c.prototype._withDependencies=function(e){for(var t={},r=0;r<e.length;r++){var a=e[r],i="load"+a.charAt(0).toUpperCase()+a.slice(1),n=this.cache.get(a);if(void 0!==n)t[a]=n;else if(this[i]){var o=this[i]();this.cache.add(a,o),t[a]=o}}return s(t,function(e){return e})},c.prototype.parse=function(e){var t=this.json;this.cache.removeAll(),this._withDependencies(["scenes","cameras","animations"]).then(function(r){var a=[];for(var i in r.scenes)a.push(r.scenes[i]);var s=void 0!==t.scene?r.scenes[t.scene]:a[0],n=[];for(var i in r.cameras){var o=r.cameras[i];n.push(o)}var l=[];for(var i in r.animations)l.push(r.animations[i]);e(s,a,n,l)})},c.prototype.loadShaders=function(){var e=this.json,t=this.extensions,r=this.options;return this._withDependencies(["bufferViews"]).then(function(a){return s(e.shaders,function(e){return e.extensions&&e.extensions[u.KHR_BINARY_GLTF]?t[u.KHR_BINARY_GLTF].loadShader(e,a.bufferViews):new Promise(function(t){var a=new THREE.FileLoader;a.setResponseType("text"),a.load(n(e.uri,r.path),function(e){t(e)})})})})},c.prototype.loadBuffers=function(){var e=this.json,t=this.extensions,r=this.options;return s(e.buffers,function(e,a){return a===d?t[u.KHR_BINARY_GLTF].body:"arraybuffer"===e.type||void 0===e.type?new Promise(function(t){var a=new THREE.FileLoader;a.setResponseType("arraybuffer"),a.load(n(e.uri,r.path),function(e){t(e)})}):void console.warn("THREE.GLTFLoader: "+e.type+" buffer type is not supported")})},c.prototype.loadBufferViews=function(){var e=this.json;return this._withDependencies(["buffers"]).then(function(t){return s(e.bufferViews,function(e){var r=t.buffers[e.buffer],a=void 0!==e.byteLength?e.byteLength:0;return r.slice(e.byteOffset,e.byteOffset+a)})})},c.prototype.loadAccessors=function(){var e=this.json;return this._withDependencies(["bufferViews"]).then(function(t){return s(e.accessors,function(e){var r=t.bufferViews[e.bufferView],a=y[e.type],i=E[e.componentType],s=i.BYTES_PER_ELEMENT,n=s*a;if(e.byteStride&&e.byteStride!==n){var o=new i(r),l=new THREE.InterleavedBuffer(o,e.byteStride/s);return new THREE.InterleavedBufferAttribute(l,a,e.byteOffset/s)}return o=new i(r,e.byteOffset,e.count*a),new THREE.BufferAttribute(o,a)})})},c.prototype.loadTextures=function(){var e=this.json,t=this.extensions,r=this.options;return this._withDependencies(["bufferViews"]).then(function(a){return s(e.textures,function(i){function s(t){if(t.flipY=!1,void 0!==i.name&&(t.name=i.name),t.format=void 0!==i.format?T[i.format]:THREE.RGBAFormat,void 0!==i.internalFormat&&t.format!==T[i.internalFormat]&&console.warn("THREE.GLTFLoader: Three.js doesn't support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),t.type=void 0!==i.type?b[i.type]:THREE.UnsignedByteType,i.sampler){var r=e.samplers[i.sampler];t.magFilter=v[r.magFilter]||THREE.LinearFilter,t.minFilter=v[r.minFilter]||THREE.NearestMipMapLinearFilter,t.wrapS=g[r.wrapS]||THREE.RepeatWrapping,t.wrapT=g[r.wrapT]||THREE.RepeatWrapping}}if(i.source)return new Promise(function(o){var l=e.images[i.source],h=l.uri;if(l.extensions&&l.extensions[u.KHR_BINARY_GLTF]&&(h=t[u.KHR_BINARY_GLTF].loadTextureSourceUri(l,a.bufferViews)),altspace&&altspace.inClient)i=new THREE.Texture({src:n(h,r.path)}),s(i),o(i);else{var c=THREE.Loader.Handlers.get(h);null===c&&(c=new THREE.TextureLoader),c.setCrossOrigin(r.crossOrigin),c.load(n(h,r.path),function(e){s(e),o(e)},void 0,function(){o()})}})})})},c.prototype.loadMaterials=function(){var e=this.json;return this._withDependencies(["shaders","textures"]).then(function(t){return s(e.materials,function(e){var r,a,i={},s={};if(e.extensions&&e.extensions[u.KHR_MATERIALS_COMMON]&&(a=e.extensions[u.KHR_MATERIALS_COMMON]),a){var n=["ambient","emission","transparent","transparency","doubleSided"];switch(a.technique){case"BLINN":case"PHONG":r=THREE.MeshPhongMaterial,n.push("diffuse","specular","shininess");break;case"LAMBERT":r=THREE.MeshLambertMaterial,n.push("diffuse");break;case"CONSTANT":default:r=THREE.MeshBasicMaterial}n.forEach(function(e){void 0!==a.values[e]&&(i[e]=a.values[e])}),(a.doubleSided||i.doubleSided)&&(s.side=THREE.DoubleSide),(a.transparent||i.transparent)&&(s.transparent=!0,s.opacity=void 0!==i.transparency?i.transparency:1)}else r=THREE.MeshPhongMaterial,Object.assign(i,e.values);Array.isArray(i.diffuse)?s.color=(new THREE.Color).fromArray(i.diffuse):"string"==typeof i.diffuse&&(s.map=t.textures[i.diffuse]),delete s.diffuse,"string"==typeof i.reflective&&(s.envMap=t.textures[i.reflective]),"string"==typeof i.bump&&(s.bumpMap=t.textures[i.bump]),Array.isArray(i.emission)?r===THREE.MeshBasicMaterial?s.color=(new THREE.Color).fromArray(i.emission):s.emissive=(new THREE.Color).fromArray(i.emission):"string"==typeof i.emission&&(r===THREE.MeshBasicMaterial?s.map=t.textures[i.emission]:s.emissiveMap=t.textures[i.emission]),Array.isArray(i.specular)?s.specular=(new THREE.Color).fromArray(i.specular):"string"==typeof i.specular&&(s.specularMap=t.textures[i.specular]),void 0!==i.shininess&&(s.shininess=i.shininess);var o=new r(s);return void 0!==e.name&&(o.name=e.name),o})})},c.prototype.loadMeshes=function(){var e=this.json;return this._withDependencies(["accessors","materials"]).then(function(t){return s(e.meshes,function(e){var r=new THREE.Group;void 0!==e.name&&(r.name=e.name),e.extras&&(r.userData=e.extras);var a=e.primitives||[];for(var i in a){var s=a[i];if(s.mode===m.TRIANGLES||void 0===s.mode){var n=new THREE.BufferGeometry,o=s.attributes;for(var h in o){var c=o[h];if(!c)return;var u=t.accessors[c];switch(h){case"POSITION":n.addAttribute("position",u);break;case"NORMAL":n.addAttribute("normal",u);break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":n.addAttribute("uv",u);break;case"TEXCOORD_1":n.addAttribute("uv2",u);break;case"COLOR_0":case"COLOR0":case"COLOR":n.addAttribute("color",u);break;case"WEIGHT":n.addAttribute("skinWeight",u);break;case"JOINT":n.addAttribute("skinIndex",u)}}s.indices&&n.setIndex(t.accessors[s.indices]);var d=void 0!==t.materials?t.materials[s.material]:l(),p=new THREE.Mesh(n,d);p.castShadow=!0,p.name="0"===i?r.name:r.name+i,s.extras&&(p.userData=s.extras),r.add(p)}else if(s.mode===m.LINES){var n=new THREE.BufferGeometry,o=s.attributes;for(var h in o){var c=o[h];if(!c)return;var u=t.accessors[c];switch(h){case"POSITION":n.addAttribute("position",u);break;case"COLOR_0":case"COLOR0":case"COLOR":n.addAttribute("color",u)}}var p,d=t.materials[s.material];s.indices?(n.setIndex(t.accessors[s.indices]),p=new THREE.LineSegments(n,d)):p=new THREE.Line(n,d),p.name="0"===i?r.name:r.name+i,s.extras&&(p.userData=s.extras),r.add(p)}else console.warn("Only triangular and line primitives are supported")}return r})})},c.prototype.loadCameras=function(){var e=this.json;return s(e.cameras,function(e){if("perspective"==e.type&&e.perspective){var t=e.perspective.yfov,r=void 0!==e.perspective.aspectRatio?e.perspective.aspectRatio:1,a=t*r,i=new THREE.PerspectiveCamera(THREE.Math.radToDeg(a),r,e.perspective.znear||1,e.perspective.zfar||2e6);return void 0!==e.name&&(i.name=e.name),e.extras&&(i.userData=e.extras),i}if("orthographic"==e.type&&e.orthographic){var i=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e.orthographic.znear,e.orthographic.zfar);return void 0!==e.name&&(i.name=e.name),e.extras&&(i.userData=e.extras),i}})},c.prototype.loadSkins=function(){var e=this.json;return this._withDependencies(["accessors"]).then(function(t){return s(e.skins,function(e){var r=new THREE.Matrix4;void 0!==e.bindShapeMatrix&&r.fromArray(e.bindShapeMatrix);var a={bindShapeMatrix:r,jointNames:e.jointNames,inverseBindMatrices:t.accessors[e.inverseBindMatrices]};return a})})},c.prototype.loadAnimations=function(){var e=this.json;return this._withDependencies(["accessors","nodes"]).then(function(t){return s(e.animations,function(e,r){var a=[];for(var i in e.channels){var s=e.channels[i],n=e.samplers[s.sampler];if(n){var o=s.target,l=o.id,h=void 0!==e.parameters?e.parameters[n.input]:n.input,c=void 0!==e.parameters?e.parameters[n.output]:n.output,u=t.accessors[h],d=t.accessors[c],p=t.nodes[l];if(p){p.updateMatrix(),p.matrixAutoUpdate=!0;var f=R[o.path]===R.rotation?THREE.QuaternionKeyframeTrack:THREE.VectorKeyframeTrack,m=p.name?p.name:p.uuid,E=void 0!==n.interpolation?w[n.interpolation]:THREE.InterpolateLinear;a.push(new f(m+"."+R[o.path],THREE.AnimationUtils.arraySlice(u.array,0),THREE.AnimationUtils.arraySlice(d.array,0),E))}}}var l=void 0!==e.name?e.name:"animation_"+r;return new THREE.AnimationClip(l,void 0,a)})})},c.prototype.loadNodes=function(){var e=this.json,t=this.extensions,r=this;return s(e.nodes,function(e){var t,r=new THREE.Matrix4;return e.jointName?(t=new THREE.Bone,t.name=void 0!==e.name?e.name:e.jointName,t.jointName=e.jointName):(t=new THREE.Object3D,void 0!==e.name&&(t.name=e.name)),e.extras&&(t.userData=e.extras),void 0!==e.matrix?(r.fromArray(e.matrix),t.applyMatrix(r)):(void 0!==e.translation&&t.position.fromArray(e.translation),void 0!==e.rotation&&t.quaternion.fromArray(e.rotation),void 0!==e.scale&&t.scale.fromArray(e.scale)),t}).then(function(a){return r._withDependencies(["meshes","skins","cameras"]).then(function(r){return s(a,function(i,s){var n=e.nodes[s];if(void 0!==n.meshes)for(var o in n.meshes){var l=n.meshes[o],h=r.meshes[l];if(void 0!==h)for(var c in h.children){var d,p=h.children[c],f=p.material,m=p.geometry,E=p.userData,v=p.name;switch(f.isDeferredShaderMaterial?f=d=f.create():d=f,p.type){case"LineSegments":p=new THREE.LineSegments(m,d);break;case"LineLoop":p=new THREE.LineLoop(m,d);break;case"Line":p=new THREE.Line(m,d);break;default:p=new THREE.Mesh(m,d)}p.castShadow=!0,p.userData=E,p.name=v;var g;if(n.skin&&(g=r.skins[n.skin]),g){var T=function(e){for(var t=Object.keys(a),r=0,i=t.length;r<i;r++){var s=a[t[r]];if(s.jointName===e)return s}return null},b=m,d=f;d.skinning=!0,p=new THREE.SkinnedMesh(b,d,!1),p.castShadow=!0,p.userData=E,p.name=v;for(var y=[],R=[],w=0,x=g.jointNames.length;w<x;w++){var A=g.jointNames[w],N=T(A);if(N){y.push(N);var M=g.inverseBindMatrices.array,H=(new THREE.Matrix4).fromArray(M,16*w);R.push(H)}else console.warn("WARNING: joint: '"+A+"' could not be found")}p.bind(new THREE.Skeleton(y,R,!1),g.bindShapeMatrix);var L=function(t,r,i){var s=t[i];if(void 0!==s)for(var n=0,o=s.length;n<o;n++){var l=s[n],h=a[l],c=e.nodes[l];void 0!==h&&h.isBone===!0&&void 0!==c&&(r.add(h),L(c,h,"children"))}};L(n,p,"skeletons")}i.add(p)}else console.warn("GLTFLoader: Couldn't find node \""+l+'".')}if(void 0!==n.camera){var _=r.cameras[n.camera];i.add(_)}if(n.extensions&&n.extensions[u.KHR_MATERIALS_COMMON]&&n.extensions[u.KHR_MATERIALS_COMMON].light){var S=t[u.KHR_MATERIALS_COMMON].lights,k=S[n.extensions[u.KHR_MATERIALS_COMMON].light];i.add(k)}return i})})})},c.prototype.loadScenes=function(){function e(r,a,i){var s=i[r];a.add(s);var n=t.nodes[r];if(n.children)for(var o=n.children,l=0,h=o.length;l<h;l++){var c=o[l];e(c,s,i)}}var t=this.json;return this._withDependencies(["nodes"]).then(function(a){return s(t.scenes,function(t){var i=new THREE.Scene;void 0!==t.name&&(i.name=t.name),t.extras&&(i.userData=t.extras);for(var s=t.nodes||[],n=0,o=s.length;n<o;n++){var l=s[n];e(l,i,a.nodes)}return i.traverse(function(e){e.material&&e.material.isRawShaderMaterial&&(e.gltfShader=new r(e,a.nodes),e.onBeforeRender=function(e,t,r){this.gltfShader.update(t,r)})}),i})})},e}(),THREE.BOMLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.BOMLoader.prototype={constructor:THREE.BOMLoader,load:function(e,t,r,a){var i=this,s=THREE.FileLoader?new THREE.FileLoader(this.manager):new THREE.XHRLoader(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.load(e,function(e){t(i.parse(e))},r,a)},setPath:function(e){this.path=e},setTexturePath:function(e){this.texturePath=e},setCrossOrigin:function(e){this.crossOrigin=e},setDebug:function(e){this.debug=e},setPerfTimer:function(e){this.performanceTimer=e},setResponseType:function(e){this.responseType=e},parse:function(e){function t(){var e=g.getUint8(T);return T+=Uint8Array.BYTES_PER_ELEMENT,e}function r(){var e=g.getUint16(T,!0);return T+=Uint16Array.BYTES_PER_ELEMENT,e}function a(){var e=g.getUint32(T,!0);return T+=Uint32Array.BYTES_PER_ELEMENT,e}function i(){var e=g.getFloat32(T,!0);return T+=Float32Array.BYTES_PER_ELEMENT,e}function s(e){var t=String.fromCharCode.apply(null,e>0?new Uint8Array(g.buffer,T,e):new Uint8Array);return T+=Uint8Array.BYTES_PER_ELEMENT*e,t}function n(e){if(T%Uint16Array.BYTES_PER_ELEMENT===0){var t=new Uint16Array(g.buffer,T,e);return T+=Uint16Array.BYTES_PER_ELEMENT*e,t}for(var t=new Uint16Array(e),r=0;r<e;++r,T+=Uint16Array.BYTES_PER_ELEMENT)t[r]=g.getUint16(T,!0);return t}function o(e){if(T%Float32Array.BYTES_PER_ELEMENT===0){var t=new Float32Array(g.buffer,T,e);return T+=Float32Array.BYTES_PER_ELEMENT*e,t}for(var t=new Float32Array(e),r=0;r<e;++r,T+=Float32Array.BYTES_PER_ELEMENT)t[r]=g.getFloat32(T,!0);return t}function l(e){if("string"!=typeof e||""===e)return"";if(/^https?:\/\//i.test(e))return e;var t=new URL((R.texturePath||R.path||"")+e,location.href.substring(0,location.href.lastIndexOf("/")+1));return t.toString()}function h(e){e=l(e);var t;if(altspace&&altspace.inClient)t=new THREE.Texture({src:e});else{var r=THREE.Loader.Handlers.get(e);null===r&&(r=new THREE.TextureLoader(R.manager)),r.setCrossOrigin(R.crossOrigin),t=r.load(e)}return t.side=THREE.FrontSide,t.wrapS=t.wrapT=THREE.RepeatWrapping,t}this.performanceTimer&&console.time("BOMLoader");var c={NONE:0,FRONT:1,BACK:2,ALL:3},u={NONE:1,MATERIAL_LIBRARY:2},d={NONE:1,NAME:2},p={NONE:1,NAME:2,INDEX:4,SMOOTHING:8,MATERIAL:16},f={NONE:1,GEOMETRY:2},m={NONE:1,NORMAL:2,UV1:4,UV2:8},E={NONE:1,ILLUMINATION_MODEL:2,SPECULAR_EXPONENT:4,OPTICAL_DENSITY:8,DISSOLVE:16,TRANSMISSION_FILTER:32,AMBIENT_REFLECTANCE:64,DIFFUSE_REFLECTANCE:128,SPECULAR_REFLECTANCE:256,EMISSIVE_REFLECTANCE:512,AMBIENT_MAP:1024,DIFFUSE_MAP:2048,SPECULAR_MAP:4096,EMISSIVE_MAP:8192,DISSOLVE_MAP:16384,BUMP_MAP:32768,DISPLACEMENT_MAP:65536,FACE_CULLING:1<<17,LIGHT_MAP:1<<18},v={NONE:1,PATH:2,SCALE:4,OFFSET:8,BUMP_SCALE:16,DISPLACEMENT_SCALE:32,LIGHTMAP_INTENSITY:64},g=new DataView(e),T=0,b="array"===this.responseType,y=b?[]:new THREE.Group,R=this,w=s(3);this.debug&&console.log("File Signature",w);var x=t();this.debug&&console.log("Version",x);var A=r();this.debug&&console.log("FileAttributes:","\n","Material Library",!!(D&u.MATERIAL_LIBRARY));var N=[];if(A&u.MATERIAL_LIBRARY){var M=r();this.debug&&console.log("Material Count",M);for(var H=0;H<M;++H){var L=a();this.debug&&console.log("MaterialAttributes:","\n","Illumination Model",!!(L&E.ILLUMINATION_MODEL),"\n","Specular Exponent",!!(L&E.SPECULAR_EXPONENT),"\n","Optical Density",!!(L&E.OPTICAL_DENSITY),"\n","Dissolve",!!(L&E.DISSOLVE),"\n","Transmission Filter",!!(L&E.TRANSMISSION_FILTER),"\n","Ambient Reflectance",!!(L&E.AMBIENT_REFLECTANCE),"\n","Diffuse Reflectance",!!(L&E.DIFFUSE_REFLECTANCE),"\n","Specular Reflectance",!!(L&E.SPECULAR_REFLECTANCE),"\n","Ambient Map",!!(L&E.AMBIENT_MAP),"\n","Diffuse Map",!!(L&E.DIFFUSE_MAP),"\n","Specular Map",!!(L&E.SPECULAR_MAP),"\n","Dissolve Map",!!(L&E.DISSOLVE_MAP),"\n","Bump Map",!!(L&E.BUMP_MAP),"\n","Displacement Map",!!(L&E.DISPLACEMENT_MAP),"\n","Face Culling",!!(L&E.FACE_CULLING),"\n","Light Map",!!(L&E.LIGHT_MAP));var _={};if(_.name=s(r()),this.debug&&console.log("Material Name",_.name),L&E.ILLUMINATION_MODEL&&t(),L&E.SPECULAR_EXPONENT&&(_.shininess=i(),this.debug&&console.log("Specular Exponent",_.shininess)),L&E.OPTICAL_DENSITY&&i(),L&E.DISSOLVE&&(_.opacity=i(),_.transparent=!0,this.debug&&console.log("Dissolve",_.opacity)),L&E.TRANSMISSION_FILTER&&(i(),i(),i()),L&E.AMBIENT_REFLECTANCE&&(i(),i(),i()),L&E.DIFFUSE_REFLECTANCE&&(_.color=new THREE.Color(i(),i(),i()),this.debug&&console.log("Diffuse Reflectance",_.color)),L&E.SPECULAR_REFLECTANCE&&(_.specular=new THREE.Color(i(),i(),i()),this.debug&&console.log("Specular Reflectance",_.specular)),L&E.EMISSIVE_REFLECTANCE&&(_.emissive=new THREE.Color(i(),i(),i()),this.debug&&console.log("Emissive Reflectance",_.emissive)),L&E.AMBIENT_MAP){var S=r();S&v.PATH&&s(r()),S&v.SCALE&&(i(),i()),S&v.OFFSET&&(i(),i())}if(L&E.DIFFUSE_MAP){var S=r(),k=h(S&v.PATH?s(r()):"");S&v.SCALE&&k.repeat.set(i(),i()),S&v.OFFSET&&k.offset.set(i(),i()),_.map=k,this.debug&&S&v.PATH&&console.log("Diffuse Map",k)}if(L&E.SPECULAR_MAP){var S=r(),k=h(S&v.PATH?s(r()):"");S&v.SCALE&&k.repeat.set(i(),i()),S&v.OFFSET&&k.offset.set(i(),i()),_.specularMap=k}if(L&E.EMISSIVE_MAP){var S=r(),k=h(S&v.PATH?s(r()):"");S&v.SCALE&&k.repeat.set(i(),i()),S&v.OFFSET&&k.offset.set(i(),i()),_.emissiveMap=k}if(L&E.DISSOLVE_MAP){var S=r(),k=h(S&v.PATH?s(r()):"");S&v.SCALE&&k.repeat.set(i(),i()),S&v.OFFSET&&k.offset.set(i(),i()),_.alphaMap=k,_.transparent=!0}if(L&E.BUMP_MAP){var S=r(),k=h(S&v.PATH?s(r()):"");S&v.SCALE&&k.repeat.set(i(),i()),S&v.OFFSET&&k.offset.set(i(),i()),S&v.BUMP_SCALE&&(_.bumpScale=i()),_.bumpMap=k}if(L&E.DISPLACEMENT_MAP){var S=r(),k=h(S&v.PATH?s(r()):"");S&v.SCALE&&k.repeat.set(i(),i()),S&v.OFFSET&&k.offset.set(i(),i()),S&v.DISPLACEMENT_SCALE&&(_.displacementScale=i()),_.displacementMap=k}if(L&E.FACE_CULLING){var O=t();O===c.ALL?_.visible=!1:O===c.FRONT?_.side=THREE.BackSide:O===c.BACK?_.side=THREE.FrontSide:_.side=THREE.DoubleSide}if(L&E.LIGHT_MAP){var S=r(),k=h(S&v.PATH?s(r()):"");S&v.SCALE&&k.repeat.set(i(),i()),S&v.OFFSET&&k.offset.set(i(),i()),S&v.LIGHTMAP_INTENSITY&&(_.lightMapIntensity=i()),_.lightMap=k}var C=new THREE.MeshPhongMaterial(_);N.push(C)}}var I=r();this.debug&&console.log("Asset Count",I);for(var F=0;F<I;++F){var j=r();this.debug&&console.log("AssetAttributes:","\n","Name",!!(j&d.NAME));var P=y;if(b&&(P=new THREE.Group,y.push(P)),j&d.NAME){var U=s(r());this.debug&&console.log("Asset Name",U),b||(P.name=U)}var B=r();this.debug&&console.log("Object Count",B);for(var H=0;H<B;++H){var D=r();this.debug&&console.log("ObjectAttributes:","\n","Geometry",!!(D&f.GEOMETRY));var V={};if(D&f.GEOMETRY){var G=r();this.debug&&console.log("GeometryAttributes:","\n","Normal",!!(G&m.NORMAL),"\n","UV1",!!(G&m.UV1),"\n","UV2",!!(G&m.UV2));var Y=a();this.debug&&console.log("Vertex Count",Y),V.positions=o(3*Y),G&m.NORMAL&&(V.normals=o(3*Y)),G&m.UV1&&(V.uvs=o(2*Y)),G&m.UV2&&(V.uvs2=o(2*Y))}var q=r();this.debug&&console.log("Group Count",q);for(var X=0;X<q;++X){var z=r();this.debug&&console.log("GroupAttributes:","\n","Index",!!(z&p.INDEX),"\n","Smoothing",!!(z&p.SMOOTHING),"\n","Material",!!(z&p.MATERIAL));var W;if(z&p.NAME&&(W=s(r()),this.debug&&console.log("Group Name",W)),D&f.GEOMETRY){var Z;if(z&p.INDEX){var K=a();this.debug&&console.log("Index Count",K),Z=n(K)}var J=z&p.SMOOTHING?t():0;this.debug&&z&p.SMOOTHING&&console.log("Smoothing",J);var Q=new THREE.BufferGeometry;V.positions&&Q.addAttribute("position",new THREE.BufferAttribute(V.positions,3)),V.normals?Q.addAttribute("normal",new THREE.BufferAttribute(V.normals,3)):Q.computeVertexNormals(),V.uvs&&Q.addAttribute("uv",new THREE.BufferAttribute(V.uvs,2)),V.uvs2&&Q.addAttribute("uv2",new THREE.BufferAttribute(V.uvs2,2)),Z&&Q.setIndex(new THREE.BufferAttribute(Z,1)),Q.addGroup(0,1,0);var C;if(z&p.MATERIAL){var $=r();C=N[$].clone()||new THREE.MeshPhongMaterial,C.shading=J>0?THREE.SmoothShading:THREE.FlatShading,this.debug&&console.log("Group Material",$,C)}var ee=new THREE.Mesh(Q,C);W&&(ee.name=W),P.add(ee)}}}}return this.performanceTimer&&console.timeEnd("BOMLoader"),y}},THREE.BOMLoaderUtil=THREE.BOMLoaderUtil||{},THREE.BOMLoaderUtil.multiload=function(e,t){function r(e,r){var s=new THREE.BOMLoader;s.setTexturePath(r.url.split("/").slice(0,-1).join("/")+"/"),void 0!==r.debug&&s.setDebug(r.debug),void 0!==r.timer&&s.setPerfTimer(r.timer),void 0!==r.crossOrigin&&s.setCrossOrigin(r.crossOrigin),void 0!==r.responseType&&s.setResponseType(r.responseType),s.load(r.url,function(s){r.object=s,i[e]=r,--a<=0&&t(i)})}e=e.constructor===Array?e:[e];for(var a=e.length,i=[],s=0;s<e.length;++s)r(s,e[s])};